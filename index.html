<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S·ªï T√≠nh N·ª£ Th·∫ª T√≠n D·ª•ng (ƒê·ªìng B·ªô Cloud)</title>
    
    <!-- Nh√∫ng Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- C·∫•u h√¨nh Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' }
                    },
                    screens: { 'xs': '475px' }
                }
            }
        }
    </script>

    <!-- Nh√∫ng Font ch·ªØ & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 transition-colors duration-300 antialiased selection:bg-indigo-500 selection:text-white pb-10">

    <div class="min-h-screen p-3 md:p-8">
        <div class="max-w-6xl mx-auto space-y-6 md:space-y-8">
            
            <!-- HEADER -->
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <div class="flex items-center space-x-3">
                    <div class="p-2.5 md:p-3 bg-indigo-600 rounded-lg shadow-lg shrink-0">
                        <i data-lucide="cloud-lightning" class="w-6 h-6 md:w-8 md:h-8 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold dark:text-white text-slate-900 leading-tight">S·ªï N·ª£ Online</h1>
                        <p class="text-slate-500 dark:text-slate-400 text-xs md:text-sm mt-0.5" id="welcomeText">
                            Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô
                        </p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-2 self-end sm:self-auto">
                    <!-- Login Button Container -->
                    <div id="authContainer">
                        <button id="btnLogin" class="flex items-center bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition active:scale-95">
                            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4 h-4 mr-2" alt="Google">
                            ƒêƒÉng nh·∫≠p b·∫±ng Google
                        </button>
                        <button id="btnLogout" class="hidden flex items-center bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-medium shadow-sm transition active:scale-95">
                            <i data-lucide="log-out" class="w-4 h-4 mr-2"></i> Tho√°t
                        </button>
                    </div>

                    <button id="themeToggle" class="p-2.5 rounded-full shadow-sm transition-all bg-white text-slate-600 hover:bg-slate-100 dark:bg-slate-700 dark:text-yellow-400 dark:hover:bg-slate-600 active:scale-95 touch-manipulation">
                        <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                        <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                    </button>
                </div>
            </div>

            <!-- LOGIN PROMPT (Hi·ªán khi ch∆∞a ƒëƒÉng nh·∫≠p) -->
            <div id="loginPrompt" class="hidden flex-col items-center justify-center py-12 bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm text-center px-4">
                <div class="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-full mb-4">
                    <i data-lucide="lock" class="w-8 h-8 text-indigo-600 dark:text-indigo-400"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-2">D·ªØ li·ªáu ƒë∆∞·ª£c b·∫£o m·∫≠t</h3>
                <p class="text-slate-500 dark:text-slate-400 max-w-md mb-6">
                    ƒêƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Google (Gmail) ƒë·ªÉ l∆∞u tr·ªØ danh s√°ch th·∫ª v√† ƒë·ªìng b·ªô h√≥a tr√™n ƒëi·ªán tho·∫°i, m√°y t√≠nh c·ªßa b·∫°n.
                </p>
                <button onclick="document.getElementById('btnLogin').click()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium shadow-md transition active:scale-95 flex items-center">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4 h-4 mr-2 brightness-0 invert" alt="Google">
                    ƒêƒÉng nh·∫≠p b·∫±ng Google
                </button>
            </div>

            <!-- MAIN CONTENT (·∫®n khi ch∆∞a ƒëƒÉng nh·∫≠p) -->
            <div id="mainApp" class="hidden space-y-6 md:space-y-8 animate-[fadeIn_0.5s_ease-out]">
                
                <!-- PH·∫¶N 1: DANH S√ÅCH TH·∫∫ -->
                <div class="rounded-xl shadow-sm border overflow-hidden transition-colors bg-white border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                    <div class="p-4 md:p-6 border-b flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 bg-slate-50 border-slate-100 dark:bg-slate-800 dark:border-slate-700">
                        <h2 class="font-semibold text-base md:text-lg flex items-center text-slate-800 dark:text-white">
                            <i data-lucide="landmark" class="w-5 h-5 mr-2 text-indigo-600"></i> 
                            Danh S√°ch Th·∫ª
                        </h2>
                        <span class="text-sm px-3 py-1.5 rounded border bg-white border-slate-200 text-slate-500 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300 w-fit">
                            T·ªïng n·ª£: <span class="font-bold text-red-500" id="totalDebtDisplay">0 ‚Ç´</span>
                        </span>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left whitespace-nowrap">
                            <thead class="uppercase font-semibold text-xs bg-slate-50 text-slate-500 dark:bg-slate-700/50 dark:text-slate-300">
                                <tr>
                                    <th class="px-4 py-3 md:px-6 md:py-4">Ng√¢n h√†ng</th>
                                    <th class="px-4 py-3 md:px-6 md:py-4 text-right">D∆∞ n·ª£</th>
                                    <th class="px-4 py-3 md:px-6 md:py-4 text-right">L√£i %</th>
                                    <th class="px-4 py-3 md:px-6 md:py-4 text-right text-red-500">L√£i (Est)</th>
                                    <th class="px-4 py-3 md:px-6 md:py-4 text-right">Min Pay</th>
                                    <th class="px-4 py-3 md:px-6 md:py-4 text-center">Ng√†y TT</th>
                                    <th class="px-4 py-3 md:px-6 md:py-4 text-center">X√≥a</th>
                                </tr>
                            </thead>
                            <tbody id="cardListBody" class="divide-y divide-slate-100 dark:divide-slate-700">
                                <!-- JS render rows here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- FORM TH√äM TH·∫∫ -->
                    <div class="border-t bg-slate-50 border-slate-200 dark:bg-slate-800/50 dark:border-slate-700 p-4 md:p-5">
                        <p class="text-xs font-semibold text-slate-500 uppercase mb-3 md:hidden">Th√™m th·∫ª m·ªõi:</p>
                        <div class="grid grid-cols-2 md:grid-cols-[2fr_1.5fr_0.8fr_1.2fr_0.8fr_auto] gap-3">
                            <div class="col-span-2 md:col-span-1">
                                <input type="text" id="newBankName" placeholder="T√™n Ng√¢n h√†ng (VD: VIB)" 
                                    class="w-full text-sm p-2.5 rounded border focus:ring-2 focus:ring-indigo-500 outline-none bg-white border-slate-300 dark:bg-slate-700 dark:border-slate-600 dark:text-white transition-all">
                            </div>
                            <div class="col-span-1">
                                <input type="number" inputmode="decimal" id="newBalance" placeholder="S·ªë d∆∞ n·ª£" 
                                    class="w-full text-sm p-2.5 md:text-right rounded border focus:ring-2 focus:ring-indigo-500 outline-none bg-white border-slate-300 dark:bg-slate-700 dark:border-slate-600 dark:text-white transition-all">
                            </div>
                            <div class="col-span-1">
                                <input type="number" inputmode="decimal" id="newInterest" placeholder="L√£i %" 
                                    class="w-full text-sm p-2.5 md:text-right rounded border focus:ring-2 focus:ring-indigo-500 outline-none bg-white border-slate-300 dark:bg-slate-700 dark:border-slate-600 dark:text-white transition-all">
                            </div>
                            <div class="col-span-1">
                                <input type="number" inputmode="decimal" id="newMinPayment" placeholder="Min Pay" 
                                    class="w-full text-sm p-2.5 md:text-right rounded border focus:ring-2 focus:ring-indigo-500 outline-none bg-white border-slate-300 dark:bg-slate-700 dark:border-slate-600 dark:text-white transition-all">
                            </div>
                            <div class="col-span-1">
                                <input type="number" inputmode="numeric" id="newDate" placeholder="Ng√†y TT" max="31" 
                                    class="w-full text-sm p-2.5 text-center rounded border focus:ring-2 focus:ring-indigo-500 outline-none bg-white border-slate-300 dark:bg-slate-700 dark:border-slate-600 dark:text-white transition-all">
                            </div>
                            <div class="col-span-2 md:col-span-1">
                                <button id="btnAddCard" class="w-full h-full min-h-[40px] flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white px-4 py-2 rounded font-medium transition shadow-sm active:scale-95 touch-manipulation disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i data-lucide="plus" class="w-4 h-4 mr-1"></i> <span class="md:hidden">Th√™m Th·∫ª</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PH·∫¶N 2: C√îNG C·ª§ T√çNH TO√ÅN (Gi·ªØ nguy√™n logic c≈©) -->
                <div id="calculatorSection" class="hidden grid-cols-1 lg:grid-cols-3 gap-6 animate-[fadeIn_0.5s_ease-out]">
                    <!-- Input K·∫ø Ho·∫°ch -->
                    <div class="lg:col-span-1 space-y-4 md:space-y-6">
                        <div class="rounded-xl shadow-sm border p-4 md:p-6 relative overflow-hidden transition-colors bg-white border-indigo-100 dark:bg-slate-800 dark:border-indigo-900">
                            <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                                <i data-lucide="credit-card" class="w-24 h-24 text-indigo-600"></i>
                            </div>
                            
                            <h2 class="text-lg font-bold mb-1 text-slate-800 dark:text-white">K·∫ø Ho·∫°ch Tr·∫£ N·ª£</h2>
                            <p class="text-sm text-indigo-500 font-medium mb-4 flex items-center truncate">
                                Th·∫ª: <span id="calcBankName" class="ml-1 truncate">...</span>
                            </p>

                            <div class="space-y-4">
                                <div class="p-3 md:p-4 rounded-lg border bg-slate-50 border-slate-200 dark:bg-slate-700/50 dark:border-slate-600 text-sm">
                                    <div class="flex justify-between mb-2">
                                        <span class="text-slate-500 dark:text-slate-400">D∆∞ n·ª£ g·ªëc</span>
                                        <span class="font-semibold dark:text-white" id="calcBalance">0 ‚Ç´</span>
                                    </div>
                                    <div class="flex justify-between mb-2">
                                        <span class="text-slate-500 dark:text-slate-400">L√£i su·∫•t</span>
                                        <span class="font-semibold dark:text-white" id="calcInterest">0%</span>
                                    </div>
                                    <div class="flex justify-between border-t border-slate-200 dark:border-slate-600 pt-2 mt-2">
                                        <span class="text-slate-500 dark:text-slate-400">T·ªëi thi·ªÉu ph·∫£i tr·∫£</span>
                                        <span class="font-bold text-indigo-600 dark:text-indigo-400" id="calcMinPayment">0 ‚Ç´</span>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">
                                        S·ªë ti·ªÅn b·∫°n tr·∫£ m·ªói th√°ng
                                    </label>
                                    <div class="relative">
                                        <input type="number" inputmode="decimal" id="plannedPayment" 
                                            class="w-full pl-4 pr-4 py-3 border-2 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none transition text-lg font-bold bg-indigo-50/50 border-indigo-100 text-indigo-700 dark:bg-slate-900 dark:border-indigo-900 dark:text-indigo-400">
                                    </div>
                                    <p id="minPaymentWarning" class="hidden text-xs text-red-500 mt-2 flex items-center font-medium">
                                        <i data-lucide="alert-circle" class="w-3 h-3 mr-1"></i> 
                                        C·∫ßn tr·∫£ > <span id="warnMinVal" class="ml-1"></span>
                                    </p>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 mt-2">
                                    <div class="p-3 rounded-lg border bg-green-50 border-green-100 dark:bg-green-900/20 dark:border-green-900/30">
                                        <p class="text-xs mb-1 text-green-600 dark:text-green-400 font-medium">Th·ªùi gian</p>
                                        <p class="font-bold text-lg text-green-800 dark:text-green-400 leading-none" id="resultMonths">‚àû</p>
                                    </div>
                                    <div class="p-3 rounded-lg border bg-red-50 border-red-100 dark:bg-red-900/20 dark:border-red-900/30">
                                        <p class="text-xs mb-1 text-red-600 dark:text-red-400 font-medium">T·ªïng l√£i</p>
                                        <p class="font-bold text-lg text-red-800 dark:text-red-400 leading-none" id="resultInterest">---</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="impossibleWarning" class="hidden border rounded-xl p-4 flex items-start space-x-3 bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-900/30">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mt-0.5 shrink-0"></i>
                            <p class="text-sm text-red-700 dark:text-red-400">
                                B·∫°n ƒëang tr·∫£ √≠t h∆°n ti·ªÅn l√£i sinh ra m·ªói th√°ng (<b id="minInterestReq">0 ‚Ç´</b>). N·ª£ s·∫Ω tƒÉng m√£i m√£i!
                            </p>
                        </div>
                    </div>

                    <!-- B·∫£ng L·ªãch Tr√¨nh Chi Ti·∫øt -->
                    <div class="lg:col-span-2">
                        <div class="rounded-xl shadow-sm border h-full flex flex-col overflow-hidden transition-colors bg-white border-slate-200 dark:bg-slate-800 dark:border-slate-700">
                            <div class="px-4 py-3 md:px-6 md:py-4 border-b flex justify-between items-center bg-slate-50 border-slate-100 dark:bg-slate-800 dark:border-slate-700">
                                <h3 class="font-semibold flex items-center text-slate-700 dark:text-slate-200">
                                    <i data-lucide="calendar" class="w-4 h-4 mr-2 text-slate-400"></i>
                                    Chi Ti·∫øt
                                </h3>
                                <span id="resultTimeText" class="text-xs font-medium text-slate-500 dark:text-slate-400 text-right">
                                    --
                                </span>
                            </div>

                            <div class="flex-1 overflow-auto max-h-[500px] md:max-h-[600px] p-0 relative">
                                <table class="w-full text-sm text-left" id="scheduleTable">
                                    <thead class="sticky top-0 z-10 shadow-sm text-xs uppercase font-semibold bg-slate-50 text-slate-500 dark:bg-slate-800 dark:text-slate-300">
                                        <tr>
                                            <th class="px-3 py-3 md:px-4 text-center">Th√°ng</th>
                                            <th class="px-3 py-3 md:px-4 text-right">G·ªëc</th>
                                            <th class="px-3 py-3 md:px-4 text-right text-red-500">L√£i</th>
                                            <th class="px-3 py-3 md:px-4 text-right">C√≤n l·∫°i</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody" class="divide-y divide-slate-100 dark:divide-slate-700"></tbody>
                                </table>
                                
                                <div id="emptyState" class="flex flex-col items-center justify-center h-64 text-slate-400 hidden p-4 text-center">
                                    <i data-lucide="trending-down" class="w-12 h-12 mb-3 opacity-20"></i>
                                    <p>Kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c k·∫ø ho·∫°ch kh√¥ng kh·∫£ thi.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="selectPrompt" class="text-center py-12 rounded-xl border border-dashed transition-colors bg-white border-slate-300 dark:bg-slate-800 dark:border-slate-700 mx-4 md:mx-0">
                    <p class="text-slate-500 dark:text-slate-400 px-4">üëÜ Ch·∫°m v√†o m·ªôt th·∫ª trong danh s√°ch ƒë·ªÉ t√≠nh to√°n.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // C·∫§U H√åNH FIREBASE C·ª¶A B·∫†N
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_qHxZns_Fq_9D5QlGY1lwUSBbhXXxbio",
            authDomain: "sono-15f94.firebaseapp.com",
            projectId: "sono-15f94",
            storageBucket: "sono-15f94.firebasestorage.app",
            messagingSenderId: "761599043769",
            appId: "1:761599043769:web:a1f57bb74f0af3f3e15368",
            measurementId: "G-8390SE6G2M"
        };
        // ==========================================

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.warn("L·ªói c·∫•u h√¨nh Firebase:", e);
        }

        // --- State ---
        let cards = [];
        let selectedCardId = null;
        let isDarkMode = false;
        let currentUser = null;

        // --- Auth Functions ---
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const provider = new GoogleAuthProvider();

        if (btnLogin) {
            btnLogin.addEventListener('click', async () => {
                if (!auth) { alert("Ch∆∞a c·∫•u h√¨nh Firebase!"); return; }
                
                // UI Feedback: ƒêang x·ª≠ l√Ω
                const originalText = btnLogin.innerHTML;
                btnLogin.disabled = true;
                btnLogin.innerHTML = `<span class="loader border-slate-400 border-t-indigo-600 w-4 h-4 mr-2"></span> ƒêang x·ª≠ l√Ω...`;
                
                try {
                    await signInWithPopup(auth, provider);
                    // onAuthStateChanged s·∫Ω t·ª± x·ª≠ l√Ω chuy·ªÉn ƒë·ªïi UI
                } catch (error) {
                    console.error(error);
                    btnLogin.disabled = false;
                    btnLogin.innerHTML = originalText;
                    
                    if (error.code === 'auth/operation-not-allowed') {
                        alert("L·ªói: B·∫°n ch∆∞a b·∫≠t 'Google Sign-in' trong Firebase Console > Authentication.");
                    } else if (window.location.protocol === 'file:') {
                        alert("L·ªói: ƒêƒÉng nh·∫≠p Google kh√¥ng ho·∫°t ƒë·ªông tr√™n file://. H√£y d√πng localhost ho·∫∑c deploy l√™n web.");
                    } else {
                        alert("ƒêƒÉng nh·∫≠p th·∫•t b·∫°i: " + error.message);
                    }
                }
            });
        }

        if (btnLogout) {
            btnLogout.addEventListener('click', () => {
                if (auth) signOut(auth);
            });
        }

        // --- Listeners ---
        if (auth) {
            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if (user) {
                    // UI: ƒê√£ ƒëƒÉng nh·∫≠p
                    document.getElementById('welcomeText').innerText = `Xin ch√†o, ${user.displayName}`;
                    document.getElementById('btnLogin').classList.add('hidden');
                    document.getElementById('btnLogout').classList.remove('hidden');
                    document.getElementById('loginPrompt').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    
                    setupRealtimeListener(user.uid);
                } else {
                    // UI: Ch∆∞a ƒëƒÉng nh·∫≠p
                    document.getElementById('welcomeText').innerText = 'Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·ªìng b·ªô';
                    document.getElementById('btnLogin').disabled = false;
                    // Reset l·∫°i n·ªôi dung n√∫t Login ph√≤ng tr∆∞·ªùng h·ª£p b·ªã k·∫πt ·ªü "ƒêang x·ª≠ l√Ω"
                    if(document.getElementById('btnLogin').innerHTML.includes('loader')) {
                         document.getElementById('btnLogin').innerHTML = `<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4 h-4 mr-2" alt="Google"> ƒêƒÉng nh·∫≠p b·∫±ng Google`;
                    }
                    document.getElementById('btnLogin').classList.remove('hidden');
                    document.getElementById('btnLogout').classList.add('hidden');
                    document.getElementById('loginPrompt').classList.remove('hidden');
                    document.getElementById('mainApp').classList.add('hidden');
                    
                    // Reset d·ªØ li·ªáu khi logout
                    cards = [];
                    renderCards();
                }
            });
        }

        function setupRealtimeListener(userId) {
            const q = query(
                collection(db, 'users', userId, 'cards'), 
                orderBy('createdAt', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                cards = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderCards();
                
                if (selectedCardId && !cards.find(c => c.id === selectedCardId)) {
                    selectedCardId = null;
                    document.getElementById('calculatorSection').classList.remove('grid');
                    document.getElementById('calculatorSection').classList.add('hidden');
                    document.getElementById('selectPrompt').classList.remove('hidden');
                } else if (selectedCardId) {
                    selectCard(selectedCardId);
                }
            }, (error) => {
                console.error("L·ªói t·∫£i d·ªØ li·ªáu:", error);
                if (error.code === 'permission-denied') {
                     alert("L·ªói quy·ªÅn truy c·∫≠p! H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ c·∫≠p nh·∫≠t Firestore Rules trong Console.");
                }
            });
        }

        // --- Core Functions (Gi·ªØ nguy√™n) ---
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', maximumFractionDigits: 0 }).format(amount);
        const calculateMonthlyInterest = (balance, rate) => balance * (rate / 100 / 12);

        function renderCards() {
            const tbody = document.getElementById('cardListBody');
            tbody.innerHTML = '';
            
            if (cards.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-slate-400 italic">Danh s√°ch tr·ªëng. Th√™m th·∫ª m·ªõi ngay!</td></tr>`;
                document.getElementById('totalDebtDisplay').innerText = formatCurrency(0);
                return;
            }

            let totalDebt = 0;
            cards.forEach(card => {
                totalDebt += card.balance;
                const interestAmt = calculateMonthlyInterest(card.balance, card.interestRate);
                const isSelected = selectedCardId === card.id;
                
                const activeClass = isSelected 
                    ? 'bg-indigo-50 dark:bg-indigo-900/30' 
                    : 'active:bg-slate-100 dark:active:bg-slate-700 md:hover:bg-slate-50 dark:md:hover:bg-slate-700';

                const tr = document.createElement('tr');
                tr.className = `cursor-pointer transition-colors border-b last:border-0 border-slate-100 dark:border-slate-700 ${activeClass} touch-manipulation`;
                tr.addEventListener('click', () => selectCard(card.id));

                tr.innerHTML = `
                    <td class="px-4 py-3 md:px-6 md:py-4 font-medium flex items-center text-slate-700 dark:text-slate-200">
                        ${isSelected ? '<i data-lucide="check-circle" class="w-4 h-4 text-indigo-500 mr-2 shrink-0"></i>' : ''}
                        <span class="truncate max-w-[120px] md:max-w-none">${card.bankName}</span>
                    </td>
                    <td class="px-4 py-3 md:px-6 md:py-4 text-right font-semibold text-slate-800 dark:text-white">${formatCurrency(card.balance)}</td>
                    <td class="px-4 py-3 md:px-6 md:py-4 text-right text-slate-600 dark:text-slate-400">${card.interestRate}%</td>
                    <td class="px-4 py-3 md:px-6 md:py-4 text-right text-red-500 font-medium">${formatCurrency(interestAmt)}</td>
                    <td class="px-4 py-3 md:px-6 md:py-4 text-right text-slate-500 dark:text-slate-400">${formatCurrency(card.minPayment)}</td>
                    <td class="px-4 py-3 md:px-6 md:py-4 text-center">
                        <span class="px-2 py-1 rounded text-xs bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300">
                            Ng√†y ${card.paymentDate}
                        </span>
                    </td>
                    <td class="px-4 py-3 md:px-6 md:py-4 text-center">
                        <button class="btn-delete p-2 rounded-full transition text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/50 active:scale-90 touch-manipulation">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                
                tr.querySelector('.btn-delete').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCard(card.id);
                });
                tbody.appendChild(tr);
            });

            document.getElementById('totalDebtDisplay').innerText = formatCurrency(totalDebt);
            if (window.lucide) window.lucide.createIcons();
        }

        window.addCard = async function() {
            if (!currentUser || !db) return;
            const name = document.getElementById('newBankName').value;
            const balance = parseFloat(document.getElementById('newBalance').value);
            const rate = parseFloat(document.getElementById('newInterest').value);
            const minPay = parseFloat(document.getElementById('newMinPayment').value);
            const date = parseInt(document.getElementById('newDate').value);

            if (!name || !balance) { alert("Vui l√≤ng nh·∫≠p t√™n ng√¢n h√†ng v√† s·ªë d∆∞ n·ª£!"); return; }

            document.getElementById('newBankName').value = '';
            document.getElementById('newBalance').value = '';
            document.getElementById('newInterest').value = '';
            document.getElementById('newMinPayment').value = '';
            document.getElementById('newDate').value = '';

            try {
                await addDoc(collection(db, 'users', currentUser.uid, 'cards'), {
                    bankName: name, balance, interestRate: rate || 0, minPayment: minPay || 0, paymentDate: date || 1, createdAt: Date.now()
                });
            } catch (e) { console.error(e); alert("L·ªói khi l∆∞u th·∫ª."); }
        }

        window.deleteCard = async function(id) {
            if (!currentUser || !db) return;
            if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th·∫ª n√†y?')) return;
            try {
                await deleteDoc(doc(db, 'users', currentUser.uid, 'cards', id));
            } catch (e) { console.error(e); alert("L·ªói khi x√≥a th·∫ª."); }
        }

        window.selectCard = function(id) {
            selectedCardId = id;
            renderCards();
            const card = cards.find(c => c.id === id);
            if (!card) return;

            document.getElementById('calculatorSection').classList.remove('hidden');
            document.getElementById('calculatorSection').classList.add('grid');
            document.getElementById('selectPrompt').classList.add('hidden');

            document.getElementById('calcBankName').innerText = card.bankName;
            document.getElementById('calcBalance').innerText = formatCurrency(card.balance);
            document.getElementById('calcInterest').innerText = card.interestRate + '%';
            document.getElementById('calcMinPayment').innerText = formatCurrency(card.minPayment);

            const defaultPlan = Math.max(card.minPayment, 2000000);
            document.getElementById('plannedPayment').value = defaultPlan;
            window.calculateSchedule();
            
            if(window.innerWidth < 768 && event && event.type === 'click') {
                document.getElementById('calculatorSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        window.calculateSchedule = function() {
            const card = cards.find(c => c.id === selectedCardId);
            if (!card) return;
            const plannedPayment = parseFloat(document.getElementById('plannedPayment').value) || 0;
            const monthlyRate = card.interestRate / 100 / 12;
            let tempBalance = card.balance;
            let totalInterest = 0;
            let months = 0;
            let scheduleHTML = '';
            let isPayable = true;
            const minInterest = tempBalance * monthlyRate;
            
            if (plannedPayment < card.minPayment) {
                document.getElementById('minPaymentWarning').classList.remove('hidden');
                document.getElementById('warnMinVal').innerText = formatCurrency(card.minPayment);
            } else {
                document.getElementById('minPaymentWarning').classList.add('hidden');
            }

            if (minInterest >= plannedPayment) isPayable = false;

            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            if (!isPayable) {
                document.getElementById('impossibleWarning').classList.remove('hidden');
                document.getElementById('minInterestReq').innerText = formatCurrency(minInterest);
                document.getElementById('resultMonths').innerText = "‚àû";
                document.getElementById('resultInterest').innerText = "---";
                document.getElementById('resultTimeText').innerText = "";
                document.getElementById('scheduleTable').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }

            document.getElementById('impossibleWarning').classList.add('hidden');
            document.getElementById('scheduleTable').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');

            while (tempBalance > 0 && months < 360) {
                months++;
                const interestPayment = tempBalance * monthlyRate;
                let principalPayment = plannedPayment - interestPayment;
                if (tempBalance < principalPayment) principalPayment = tempBalance;
                totalInterest += interestPayment;
                tempBalance -= principalPayment;
                if (tempBalance < 0) tempBalance = 0;

                scheduleHTML += `
                    <tr class="transition-colors hover:bg-indigo-50/30 dark:hover:bg-indigo-900/20">
                        <td class="px-3 py-3 md:px-4 font-medium text-center text-slate-700 dark:text-slate-300">${months}</td>
                        <td class="px-3 py-3 md:px-4 text-right text-slate-600 dark:text-slate-400">${formatCurrency(principalPayment)}</td>
                        <td class="px-3 py-3 md:px-4 text-right text-red-500">${formatCurrency(interestPayment)}</td>
                        <td class="px-3 py-3 md:px-4 text-right font-medium text-slate-700 dark:text-slate-300">
                            ${tempBalance === 0 
                                ? `<span class="inline-flex items-center font-bold justify-end text-green-600 dark:text-green-400">H·∫øt <i data-lucide="check-circle" class="w-3 h-3 ml-1"></i></span>` 
                                : formatCurrency(tempBalance)}
                        </td>
                    </tr>
                `;
            }
            tbody.innerHTML = scheduleHTML;
            document.getElementById('resultMonths').innerText = `${months} th√°ng`;
            document.getElementById('resultInterest').innerText = formatCurrency(totalInterest);
            document.getElementById('resultTimeText').innerText = `~ ${Math.floor(months/12)} nƒÉm ${months%12} th√°ng`;
            if (window.lucide) window.lucide.createIcons();
        }

        // --- Event Binding ---
        document.getElementById('plannedPayment').addEventListener('input', window.calculateSchedule);
        document.getElementById('btnAddCard').addEventListener('click', window.addCard);
        document.getElementById('themeToggle').addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            if (isDarkMode) document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
            renderCards();
        });

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            isDarkMode = true;
            document.documentElement.classList.add('dark');
        }
    </script>
</body>
</html>
